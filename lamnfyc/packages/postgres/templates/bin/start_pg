#!/usr/bin/env bash -e

if _check_process $POSTGRES_PID; then
  echo "Postgres is already running."
  exit
fi

# create a the db if it doesnt exist
if [ ! -e $VIRTUAL_ENV/data ]; then
  $VIRTUAL_ENV/bin/initdb -D $VIRTUAL_ENV/data -EUTF-8 --locale=$LANG
fi

OPTIONS="-c max_files_per_process={{options.max_files_per_process}} "`
        `"-c max_connections={{options.max_connections}} "`
        `"-d 5"`
        {% if options.unix_sockets %}`"-c unix_socket_directories=$VIRTUAL_ENV/run "{% else %}`"-h $PGHOST -p $PGPORT"{% endif %}

echo "Starting postgres"
_check_and_set_sysctl

$VIRTUAL_ENV/bin/pg_ctl start \
  -D $VIRTUAL_ENV/data \
  -w \
  -o "$OPTIONS" \
  -l $VIRTUAL_ENV/logs/postgres.log
